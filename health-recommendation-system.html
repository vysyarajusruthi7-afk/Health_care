<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Health Recommendation System</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:900px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }
        .header{ background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:30px; text-align:center; position:relative; }
        .nav-tabs{ display:flex; background:rgba(255,255,255,0.1); margin-top:20px; border-radius:10px; overflow:hidden; justify-content:center; }
        .nav-tab{ padding:12px 24px; background:white; border:none; color:#667eea; cursor:default; font-weight:600; border-radius:8px; }
        .content{ padding:40px; }
        .symptom-section{ margin-bottom:30px; }
        .symptom-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
        .symptom-card{ background:#f8f9fa; padding:15px; border-radius:10px; cursor:pointer; transition:all .3s ease; border:2px solid transparent; }
        .symptom-card.selected{ background:#667eea; color:white; border-color:#764ba2; }
        .patient-info{ display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
        .severity-selector{ margin:20px 0; }
        .severity-options{ display:flex; gap:10px; }
        .severity-btn{ flex:1; padding:12px; border:2px solid #ddd; background:white; border-radius:8px; cursor:pointer; transition:all .3s ease; font-weight:600; }
        .severity-btn.active{ background:#667eea; color:white; border-color:#667eea; }
        .analyze-btn{ width:100%; padding:15px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:10px; font-size:1.1em; font-weight:600; cursor:pointer; margin-top:20px; }
        .results{ display:none; margin-top:30px; }
        .results.show{ display:block; animation:fadeIn .5s ease; }
        @keyframes fadeIn{ from{ opacity:0; transform:translateY(20px); } to{ opacity:1; transform:translateY(0); } }
        .alert-box{ padding:20px; border-radius:10px; margin-bottom:20px; font-weight:600; }
        .alert-warning{ background:#fff3cd; border-left:5px solid #ffc107; color:#856404; }
        .alert-danger{ background:#f8d7da; border-left:5px solid #dc3545; color:#721c24; }
        .alert-success{ background:#d4edda; border-left:5px solid #28a745; color:#155724; }
        .recommendation-section{ background:#f8f9fa; padding:25px; border-radius:10px; margin-bottom:20px; }
        .recommendation-section h3{ color:#667eea; margin-bottom:15px; font-size:1.3em; }
        .recommendation-list{ list-style:none; }
        .recommendation-list li{ padding:10px 0; padding-left:25px; position:relative; display:flex; align-items:flex-start; gap:10px; }
        .recommendation-list li:before{ content:"‚úì"; position:absolute; left:0; color:#667eea; font-weight:bold; }

        .reset-btn{ padding:12px 30px; background:white; color:#667eea; border:2px solid #667eea; border-radius:8px; cursor:pointer; font-weight:600; transition:all .3s ease; }
        .reset-btn:hover{ background:#667eea; color:white; }

        .small-muted{ font-size:.85em; color:#666; margin-left:6px; font-weight:400; }
        .infermedica-conds{ margin-bottom:16px; padding:12px; border-radius:8px; background:#eef2ff; color:#1f2937; }

        /* Medication info UI */
        .med-info-btn{ padding:6px 10px; border-radius:6px; border:1px solid #667eea; background:white; color:#667eea; cursor:pointer; font-weight:600; font-size:.9em; }
        .med-info-btn:hover{ background:#eef2ff; }
        .med-info { margin-top:8px; padding:10px; border-radius:8px; background:#fff; border:1px solid #eee; font-size:.95em; display:none; }
        .med-info.show { display:block; }
        .med-info .row { margin-bottom:6px; color:#333; }
        .med-info a { color:#1d4ed8; text-decoration:underline; font-weight:600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Intelligent Health Guide</h1>
            <p>Your virtual health companion for common ailments</p>
            <div class="nav-tabs">
                <div class="nav-tab">New Assessment</div>
            </div>
        </div>

        <div class="content">
            <!-- Assessment Tab (only) -->
            <div id="assessment">
                <div class="symptom-section">
                    <h2>Select Your Symptoms</h2>
                    <div class="symptom-grid" id="symptomGrid"></div>
                </div>

                <div class="patient-info">
                    <label>Age:
                        <input type="number" id="ageInput" min="0" max="120" value="30" />
                    </label>

                    <label>Sex:
                        <select id="sexInput">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </label>

                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="useInfermedica" />
                        Use Infermedica
                        <span class="small-muted">(optional - requires App-Id & App-Key)</span>
                    </label>

                    <div id="infermedicaKeys" style="display:none;gap:8px;align-items:center;">
                        <input type="text" id="infermedicaAppId" placeholder="App-Id" />
                        <input type="text" id="infermedicaAppKey" placeholder="App-Key" />
                    </div>
                </div>

                <div class="severity-selector">
                    <label>How severe are your symptoms?</label>
                    <div class="severity-options">
                        <button class="severity-btn" data-severity="mild">Mild</button>
                        <button class="severity-btn" data-severity="moderate">Moderate</button>
                        <button class="severity-btn" data-severity="severe">Severe</button>
                    </div>
                </div>

                <button class="analyze-btn" id="analyzeBtn" disabled>Get Recommendations</button>

                <div class="results" id="results"></div>
            </div>
        </div>
    </div>

    <script>
        const symptoms = [
            { id: 'fever', name: 'Fever', desc: 'High temperature' },
            { id: 'cold', name: 'Cold', desc: 'Runny / stuffy nose' },
            { id: 'cough', name: 'Cough', desc: 'Dry or wet cough' },
            { id: 'headache', name: 'Headache', desc: 'Head pain' },
            { id: 'fatigue', name: 'Fatigue / Tiredness', desc: 'Low energy or tiredness' },
            { id: 'sore_throat', name: 'Sore Throat', desc: 'Throat pain' },
            { id: 'body_pain', name: 'Body Pains', desc: 'Muscle aches / generalized pain' },
            { id: 'nausea', name: 'Nausea', desc: 'Feeling like vomiting' },
            { id: 'vomiting', name: 'Vomiting', desc: 'Throwing up' },
            { id: 'diarrhea', name: 'Diarrhea', desc: 'Loose stools / frequent motions' },
            { id: 'motion_sickness', name: 'Motion Sickness', desc: 'Nausea/dizziness from travel' },
            { id: 'fainting', name: 'Fainting / Syncope', desc: 'Brief loss of consciousness' },
            { id: 'menstrual', name: 'Periods / Menstrual Pain', desc: 'Cramping during periods' },
            { id: 'leg_pain', name: 'Leg Pain', desc: 'Pain in legs' },
            { id: 'back_pain', name: 'Back Pain', desc: 'Lower/upper back pain' },
            { id: 'stomach_pain', name: 'Stomach Pain', desc: 'Abdominal / stomach pain' },
            { id: 'indigestion', name: 'Indigestion / Gastric', desc: 'Heartburn, bloating, gas' },
            { id: 'rash', name: 'Skin Rash', desc: 'Redness, itching or bumps' },
            { id: 'neck_pain', name: 'Neck Pain', desc: 'Stiff or painful neck' },
            { id: 'dizziness', name: 'Dizziness', desc: 'Light‚Äëheaded or unsteady' }
        ];

        const recommendations = {
            fever: {
                medicines: ['Paracetamol (500mg)', 'Ibuprofen (as directed)'],
                diet: ['Stay hydrated', 'Light soups', 'Fruits'],
                remedies: ['Cool compress', 'Rest'],
                exercises: ['Rest']
            },
            cold: {
                medicines: ['Antihistamine', 'Decongestant'],
                diet: ['Warm fluids', 'Ginger', 'Honey/lemon'],
                remedies: ['Steam inhalation', 'Nasal saline'],
                exercises: ['Light walking']
            },
            cough: {
                medicines: ['Cough syrup / lozenges'],
                diet: ['Warm drinks', 'Honey'],
                remedies: ['Steam', 'Humidifier'],
                exercises: ['Breathing exercises']
            },
            headache: {
                medicines: ['Paracetamol', 'Ibuprofen'],
                diet: ['Hydrate', 'Small regular meals'],
                remedies: ['Dark quiet room', 'Cold/warm compress'],
                exercises: ['Neck stretches', 'Relaxation']
            },
            fatigue: {
                medicines: ['Multivitamin (if needed)'],
                diet: ['Balanced meals', 'Hydration'],
                remedies: ['Sleep hygiene', 'Short naps'],
                exercises: ['Light cardio', 'Stretching']
            },
            sore_throat: {
                medicines: ['Lozenges', 'Analgesic if needed'],
                diet: ['Warm liquids', 'Soft foods'],
                remedies: ['Salt water gargle', 'Steam'],
                exercises: ['Rest voice']
            },
            body_pain: {
                medicines: ['Ibuprofen', 'Topical analgesic'],
                diet: ['Anti-inflammatory foods'],
                remedies: ['Heat/ice', 'Massage'],
                exercises: ['Gentle stretching']
            },
            nausea: {
                medicines: ['Antiemetic (as directed)'],
                diet: ['Small bland meals', 'Ginger', 'Crackers'],
                remedies: ['Fresh air', 'Peppermint'],
                exercises: ['Rest']
            },
            vomiting: {
                medicines: ['Antiemetic if persistent'],
                diet: ['Small sips of oral rehydration', 'BRAT foods when stable'],
                remedies: ['Rest', 'Avoid strong smells'],
                exercises: ['Rest']
            },
            diarrhea: {
                medicines: ['ORS', 'Probiotics if appropriate'],
                diet: ['ORS', 'BRAT diet', 'Avoid dairy/spicy'],
                remedies: ['Hydration', 'Rest'],
                exercises: ['Rest']
            },
            motion_sickness: {
                medicines: ['Antihistamine (meclizine) if suitable'],
                diet: ['Light snacks', 'Avoid heavy meals before travel'],
                remedies: ['Look at horizon', 'Fresh air', 'Ginger'],
                exercises: ['Sit still, avoid sudden movements']
            },
            fainting: {
                medicines: [],
                diet: ['Stay hydrated', 'Eat regularly to avoid low sugar'],
                remedies: ['Lie flat and elevate legs', 'Seek medical evaluation'],
                exercises: ['Avoid sudden standing']
            },
            menstrual: {
                medicines: ['NSAIDs (ibuprofen) for cramps'],
                diet: ['Warm fluids', 'Light, balanced meals'],
                remedies: ['Heat pack on abdomen', 'Rest'],
                exercises: ['Light walking', 'Gentle stretching']
            },
            leg_pain: {
                medicines: ['NSAIDs as appropriate'],
                diet: ['Hydration', 'Electrolytes if cramps'],
                remedies: ['Stretching', 'Heat/ice', 'Elevation'],
                exercises: ['Leg stretches', 'Walking']
            },
            back_pain: {
                medicines: ['NSAIDs', 'Topical analgesics'],
                diet: ['Anti-inflammatory foods'],
                remedies: ['Heat/ice', 'Proper posture', 'Stretching'],
                exercises: ['Core strengthening', 'Gentle stretching']
            },
            stomach_pain: {
                medicines: ['Antacid / antispasmodic as appropriate'],
                diet: ['Bland foods', 'Avoid greasy/spicy items'],
                remedies: ['Warm compress', 'Small frequent meals'],
                exercises: ['Gentle walking']
            },
            indigestion: {
                medicines: ['Antacids', 'H2 blockers if needed'],
                diet: ['Avoid late heavy meals', 'Small portions'],
                remedies: ['Avoid lying down immediately after eating'],
                exercises: ['Light walking after meals']
            },
            rash: {
                medicines: ['Antihistamine for itch', 'Topical emollients'],
                diet: ['Avoid known triggers'],
                remedies: ['Cool compress', 'Avoid scratching'],
                exercises: ['Avoid irritants']
            },
            neck_pain: {
                medicines: ['NSAIDs', 'Topical analgesic'],
                diet: ['Stay hydrated'],
                remedies: ['Neck stretches', 'Heat/ice', 'Posture correction'],
                exercises: ['Range-of-motion exercises']
            },
            dizziness: {
                medicines: ['Anti-vertigo meds if prescribed'],
                diet: ['Hydrate', 'Small frequent meals'],
                remedies: ['Sit/lie down if dizzy', 'Avoid sudden movements'],
                exercises: ['Balance exercises carefully']
            }
        };

        let selectedSymptoms = new Set();
        let selectedSeverity = '';
        let db;

        // Initialize IndexedDB (kept for storing assessments if needed)
        function initDB() {
            const request = indexedDB.open('HealthDB', 1);
            
            request.onerror = function() {
                console.error('Database failed to open');
            };
            
            request.onsuccess = function() {
                db = request.result;
                console.log('Database initialized successfully');
            };
            
            request.onupgradeneeded = function(e) {
                db = e.target.result;
                if (!db.objectStoreNames.contains('assessments')) {
                    const objectStore = db.createObjectStore('assessments', { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    objectStore.createIndex('severity', 'severity', { unique: false });
                }
            };
        }

        // Save assessment to IndexedDB
        function saveAssessment(assessment) {
            if (!db) {
                console.error('Database not initialized');
                return;
            }
            
            const transaction = db.transaction(['assessments'], 'readwrite');
            const objectStore = transaction.objectStore('assessments');
            const request = objectStore.add(assessment);
            
            request.onsuccess = function() {
                console.log('Assessment saved successfully');
            };
            
            request.onerror = function() {
                console.error('Error saving assessment');
            };
        }

        // Infermedica symptom mapping (placeholder ids) - replace with correct s_ ids from Infermedica
        const symptomToInfermedica = {
            fever: 's_21',        // update with correct Infermedica symptom id for fever
            cold: 's_98',        // update
            cough: 's_10',       // update
            headache: 's_15',    // update
            fatigue: 's_23',     // update
            sore_throat: 's_60', // update
            body_pain: 's_12',   // update
            nausea: 's_45',      // update
            diarrhea: 's_50',    // update
            dizziness: 's_70'    // update
        };

        // Call Infermedica diagnosis endpoint
        async function callInfermedica(selectedIds, age, sex, appId, appKey) {
            // build evidence
            const evidence = selectedIds.map(id => {
                const symId = symptomToInfermedica[id];
                if (!symId) return null;
                return { id: symId, choice_id: 'present' };
            }).filter(Boolean);

            if (evidence.length === 0) {
                throw new Error('No mapped symptoms for Infermedica. Update mapping.');
            }

            const payload = { sex: sex || 'male', age: Number(age) || 30, evidence };

            const res = await fetch('https://api.infermedica.com/v3/diagnosis', {
                method: 'POST',
                headers: {
                    'App-Id': appId,
                    'App-Key': appKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`Infermedica API error ${res.status}: ${text}`);
            }

            return res.json();
        }

        // Medication info integration: RxNav (RxNorm) - no API key
        const medInfoCache = {};

        function normalizeMedName(name) {
            // remove dosage parentheses and trim
            return name.replace(/\(.*?\)/g, '').replace(/\s+/g, ' ').trim();
        }

        async function fetchMedicationInfo(medName) {
            const normalized = normalizeMedName(medName);
            if (medInfoCache[normalized]) return medInfoCache[normalized];

            // 1) lookup rxcui by name
            const lookupUrl = `https://rxnav.nlm.nih.gov/REST/rxcui.json?name=${encodeURIComponent(normalized)}`;
            const res1 = await fetch(lookupUrl);
            if (!res1.ok) throw new Error(`RxNav lookup failed (${res1.status})`);
            const data1 = await res1.json();
            const rxcui = data1.idGroup?.rxnormId?.[0] || null;
            if (!rxcui) {
                medInfoCache[normalized] = { found:false, name:normalized };
                return medInfoCache[normalized];
            }

            // 2) fetch properties
            const propRes = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/properties.json`);
            if (!propRes.ok) throw new Error(`RxNav properties failed (${propRes.status})`);
            const propData = await propRes.json();
            const props = propData.properties || {};

            // cache and return
            medInfoCache[normalized] = { found:true, rxcui, properties: props, name: normalized };
            return medInfoCache[normalized];
        }

        // Render symptoms
        const symptomGrid = document.getElementById('symptomGrid');
        symptoms.forEach(symptom => {
            const card = document.createElement('div');
            card.className = 'symptom-card';
            card.innerHTML = `<h3>${symptom.name}</h3><p>${symptom.desc}</p>`;
            card.onclick = function() {
                toggleSymptom(symptom.id, card);
            };
            symptomGrid.appendChild(card);
        });

        // Severity selection
        document.querySelectorAll('.severity-btn').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedSeverity = btn.dataset.severity;
                updateAnalyzeButton();
            };
        });

        // toggle infermedica keys visibility
        document.getElementById('useInfermedica').addEventListener('change', (e) => {
            document.getElementById('infermedicaKeys').style.display = e.target.checked ? 'flex' : 'none';
        });

        function toggleSymptom(id, card) {
            if (selectedSymptoms.has(id)) {
                selectedSymptoms.delete(id);
                card.classList.remove('selected');
            } else {
                selectedSymptoms.add(id);
                card.classList.add('selected');
            }
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            document.getElementById('analyzeBtn').disabled = selectedSymptoms.size === 0 || !selectedSeverity;
        }

        document.getElementById('analyzeBtn').onclick = analyzeSymptoms;

        // helper to create medicine list items with info button
        function medicineListItemHTML(medName) {
            const safeId = 'med-' + encodeURIComponent(medName.replace(/\s+/g, '-').toLowerCase());
            return `<span style="flex:1">${medName}</span>
                    <button class="med-info-btn" data-med="${escapeHtml(medName)}" data-target="${safeId}">Info</button>
                    <div id="${safeId}" class="med-info" aria-hidden="true"></div>`;
        }

        // simple escape for attribute storage
        function escapeHtml(s) { return String(s).replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }

        async function analyzeSymptoms() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');

            const selectedArray = Array.from(selectedSymptoms);
            const age = document.getElementById('ageInput').value;
            const sex = document.getElementById('sexInput').value;
            const useInfermedica = document.getElementById('useInfermedica').checked;
            const appId = document.getElementById('infermedicaAppId').value.trim();
            const appKey = document.getElementById('infermedicaAppKey').value.trim();

            let infermedicaResult = null;
            if (useInfermedica) {
                if (!appId || !appKey) {
                    resultsDiv.innerHTML = `<div class="alert-box alert-warning">Infermedica selected but App-Id/App-Key not provided. Falling back to local recommendations.</div>`;
                } else {
                    try {
                        const data = await callInfermedica(selectedArray, age, sex, appId, appKey);
                        infermedicaResult = data;
                    } catch (err) {
                        resultsDiv.innerHTML = `<div class="alert-box alert-warning">Infermedica call failed: ${err.message}. Continuing with local recommendations.</div>`;
                    }
                }
            }

            let html = '';

            // Show Infermedica conditions if present
            if (infermedicaResult && Array.isArray(infermedicaResult.conditions) && infermedicaResult.conditions.length > 0) {
                html += `<div class="infermedica-conds"><strong>Infermedica ‚Äî Top conditions:</strong><ul>`;
                infermedicaResult.conditions.slice(0, 5).forEach(c => {
                    const name = c.common_name || c.name || c.id;
                    const prob = (c.probability ? (c.probability * 100).toFixed(1) + '%' : '');
                    html += `<li>${name} ${prob ? '‚Äî ' + prob : ''}</li>`;
                });
                html += `</ul></div>`;
            }

            // Check if needs doctor immediately
            const needsDoctor = selectedSeverity === 'severe' || (selectedSeverity === 'moderate' && selectedSymptoms.size > 3);

            if (needsDoctor) {
                html += `<div class="alert-box alert-danger">‚ö†Ô∏è <strong>SEEK MEDICAL ATTENTION:</strong> Based on your symptoms and severity, consult a healthcare professional.</div>`;
            } else if (selectedSeverity === 'moderate') {
                html += `<div class="alert-box alert-warning">‚ö° <strong>Monitor Closely:</strong> If symptoms worsen or persist beyond 3-4 days, consult a doctor.</div>`;
            } else {
                html += `<div class="alert-box alert-success">‚úÖ <strong>Self-care Advice:</strong> These recommendations may help. If symptoms persist, seek medical advice.</div>`;
            }

            // Aggregate recommendations across selected symptoms
            const agg = { medicines: new Set(), diet: new Set(), remedies: new Set(), exercises: new Set() };
            selectedArray.forEach(id => {
                const rec = recommendations[id];
                if (!rec) return;
                rec.medicines?.forEach(m => agg.medicines.add(m));
                rec.diet?.forEach(d => agg.diet.add(d));
                rec.remedies?.forEach(r => agg.remedies.add(r));
                rec.exercises?.forEach(e => agg.exercises.add(e));
            });

            function setToList(set, isMedicine=false) {
                if (!set || set.size === 0) return '<li>No specific recommendations.</li>';
                return Array.from(set).map(item => {
                    if (isMedicine) return `<li>${medicineListItemHTML(item)}</li>`;
                    return `<li><span style="flex:1">${item}</span></li>`;
                }).join('');
            }

            html += `
                <div class="recommendation-section">
                    <h3>ü©∫ Suggested Medicines / OTC</h3>
                    <ul class="recommendation-list">
                        ${setToList(agg.medicines, true)}
                    </ul>
                    <div class="small-muted">Tap "Info" to fetch medication identifiers (RxCUI) and quick links (RxNorm / DailyMed).</div>
                </div>

                <div class="recommendation-section">
                    <h3>üçé Dietary Advice</h3>
                    <ul class="recommendation-list">
                        ${setToList(agg.diet)}
                    </ul>
                </div>

                <div class="recommendation-section">
                    <h3>üè° Home Remedies</h3>
                    <ul class="recommendation-list">
                        ${setToList(agg.remedies)}
                    </ul>
                </div>

                <div class="recommendation-section">
                    <h3>üèÉ‚Äç‚ôÄÔ∏è Activity / Exercises</h3>
                    <ul class="recommendation-list">
                        ${setToList(agg.exercises)}
                    </ul>
                </div>

                <div style="display:flex;gap:12px;align-items:center;margin-top:10px;">
                    <button class="reset-btn" id="resetBtn">Start New Assessment</button>
                </div>
            `;

            resultsDiv.innerHTML += html;
            resultsDiv.classList.add('show');

            // Save assessment to DB (including Infermedica result summary if any)
            const assessment = {
                symptoms: selectedArray,
                severity: selectedSeverity,
                timestamp: Date.now(),
                age: Number(age),
                sex: sex,
                infermedica: infermedicaResult ? { conditions: (infermedicaResult.conditions || []).slice(0,3).map(c=>({ id:c.id, name:c.name, probability:c.probability })) } : null
            };

            saveAssessment(assessment);

            // Wire reset button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.onclick = resetAssessment;
        }

        function resetAssessment() {
            selectedSymptoms.clear();
            selectedSeverity = '';
            document.querySelectorAll('.symptom-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
            updateAnalyzeButton();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('show');
        }

        // Delegate click for med info buttons
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest && e.target.closest('.med-info-btn');
            if (!btn) return;
            const med = btn.dataset.med;
            const targetId = btn.dataset.target;
            const container = document.getElementById(targetId);
            if (!container) return;

            // toggle if already shown
            if (container.classList.contains('show')) {
                container.classList.remove('show');
                container.innerHTML = '';
                btn.textContent = 'Info';
                return;
            }

            // show loading
            container.classList.add('show');
            container.innerHTML = `<div class="row">Loading info for <strong>${med}</strong>‚Ä¶</div>`;
            btn.textContent = 'Loading‚Ä¶';

            try {
                const info = await fetchMedicationInfo(med);
                if (!info.found) {
                    container.innerHTML = `<div class="row">No RxNorm match found for <strong>${info.name}</strong>.</div>
                    <div class="row">Try searching on DailyMed: <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(info.name)}" target="_blank" rel="noopener">DailyMed</a></div>`;
                } else {
                    const p = info.properties || {};
                    container.innerHTML = `
                        <div class="row"><strong>RxCUI:</strong> ${info.rxcui}</div>
                        <div class="row"><strong>Name:</strong> ${escapeHtml(p.name || p.displayName || info.name)}</div>
                        <div class="row"><strong>Synonym:</strong> ${escapeHtml(p.synonym || p.termType || 'N/A')}</div>
                        <div class="row"><strong>RxNorm ID:</strong> ${escapeHtml(p.rxnormId || 'N/A')}</div>
                        <div class="row">Quick links: 
                            <a href="https://rxnav.nlm.nih.gov/REST/rxcui/${info.rxcui}/" target="_blank" rel="noopener">RxNorm</a>
                            &nbsp;|&nbsp;
                            <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(info.name)}" target="_blank" rel="noopener">DailyMed</a>
                        </div>
                    `;
                }
            } catch (err) {
                container.innerHTML = `<div class="row">Error fetching info: ${escapeHtml(err.message)}</div>
                    <div class="row">Try searching on DailyMed: <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(med)}" target="_blank" rel="noopener">DailyMed</a></div>`;
            } finally {
                btn.textContent = 'Info';
            }
        });

        // initialize DB on load
        window.addEventListener('load', () => { initDB(); });
    </script>
</body>
</html>